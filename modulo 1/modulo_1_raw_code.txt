#--------------------------GROPROCESSAMENTO APLICADO - PPEC - UFBA - 2020.2 - JULIO PEDRASSOLI-----------------------------------------#

#--------------------------MODULO 1----------------------------------------------------------------------------------------------------#

# DICA: ANTES DE COMECAR CRIE UM NOVO PROJETO E AJUSTE A PASTA DE DESTINO E ORIGEM DOS DADOS DESTE PROJETO -> SESSION -> SET WORKING DIRECTORY

# -------------------------ACESSO, BUSCA, FILTRAGEM E EXPORTACAO DE BASES DE DADOS ONLINE----------------------------------------------#

# INSTALACAO DE PACOTES:

install.packages('devtools')
devtools::install_github("rfsaldanha/microdatasus")

install.packages("dplyr")

# CARREGAMENTO DOS PACOTES QUE SERAO UTILIZADOS
# NESTE CASO, CARREGAMOS O PACOTE MICRODATASUS, QUE VAI ACESSAR AS BASES DO DATASUS DIRETAMENTE DO R, FAZER UMA BUSCA DE ACORDO
# COM OS PARAMETROS QUE DEFINIRMOS (DATA, LOCAL E QUAL O SUBSISTEMA DO DATASUS) E O dplyr, QUE VAI NOS AJUDAR NAS FILTRAGENS:

library(microdatasus)
library(dplyr)

# O MICRODATASUS POSSUI APENAS DUAS FUNCOES: FETCH_DATASUS (QUE FAZ BUSCA E FILTRAGEM) E O PROCESS_SIH (QUE PEGA ESSE ARQUIVO
# QUE FOI GERADO E O TRANSFORMA EM UMA TABELA MANIPULAVEL PELO R). PARA CONHECER E ENTENDER TODOS OS PARAMETROS, VISITE O WIKI
# DO PACOTE EM https://github.com/rfsaldanha/microdatasus/wiki

# AQUI CRIAMOS A PRIMEIRA BASE DE DADOS PARA ANALISE: BAIXAREMOS TODOS OS DADOS DE 2019 PARA O ESTADO DA BAHIA DO SISTEMA SIH-RD
# VIDE O LINK ACIMA PARA ENTENDER A DIFERENCA ENTRE O SIH (SISTEMA DE INFORMACOES HOSPITALARES) E OS OUTROS SISTEMAS DO DATASUS ACESSIVEIS.
# NESTE EXEMPLO, VOU SOLICITAR A BUSCA PARA O ANO DE 2019, DO MES DE JANEIRO (1) A DEZEMBO (12), PARA O ESTADO DA BAHIA, NO SISTEMA SIH-RD.
# AO EXECUTAR A LINHA, AGUARDE O PROCESSAMENTO ATE O FINAL QUE SERA REALIZADO MES A MES:

dados <- fetch_datasus(year_start = 2019, month_start = 1, year_end = 2019, month_end = 12,uf = "BA", information_system = "SIH-RD")

# APOS BAIXAR OS DADOS PODEMOS FORMATA-LOS NO MESMO CODIGO DO R:

dados_sih_ba_2019 <- process_sih(dados)

# OBSERVE QUE APOS A EXECUCAO DOS COMANDOS FETCH E PROCESS AS "TABELAS" SAO CARREGADAS NA JANELA DO CANTO SUPERIOR DO R. PODEMOS CHAMAR 
# ESSA JANELA DE AMBIENTE E NELA PODEMOS CLICAR SOBRE O OBJETO, UMA NOVA ABA VAI SE ABRIR NA JANELA PRINCIPAL DO RSTUDIO, E, ASSIM,
# PODEMOS, INICIALMENTE, EXPLORAR OS DADOS. FACA ISSO E IDENTIFIQUE CAMPOS DE INTERESSE QUE PODERIAM SER UTILIZADOS EM UM PROCESSO DE
# MAPEAMENTO. 

# TENHA EM MENTE QUE CADA LINHA E UMA AIH (AUTORIZACAO DE INTERNACAO HOSPITALAR) E OUTRAS VARIAVEIS DIZEM RESPEITO AS CARACTERISTICAS DO
# PACIENTE, COMO SEXO, IDADE, E CEP DE RESIDENCIA, HOSPITAL DE INTERNACAO, CUSTOS RELACIONADOS AO ATENDIMENTO, DENTRE OUTROS. UMA MESMA 
# PESSOA PODE APARECER VARIAS VEZES EM LINHAS DIFERENTES DA TABELA.MAS POR HORA VAMOS IGNORAR ISSO, CONTANDO, QUE NESSE EXEMPLO, 
# HAVERA POUCA INFLUENCIA PARA FINS DA ESTATISTICA ESPACIAL QUE FAREMOS.

# SE O CEP ESTA LA E QUEREMOS UTILIZA-LO, E BOM ENTENDERMOS O QUE E UM CEP: https://www.correios.com.br/enviar-e-receber/ferramentas/cep/estrutura-do-cep

# TENDO O CEP, SERIA INTERESSANTE SABER A QUE CIDADE E BAIRRO ESSE CEP SE REFERE. MAS PARA FACILITAR, PODEMOS ALICAR UM
# FILTRO NOS DADOS DA BAHIA PARA UMA UNICA CIDADE. SE OLHAR A BASE NOVAMENTE VAI ENCONTRAR O CAMPO "MUNIC_RES", QUE SE REFERE AO
# CODIGO DO MUNICIPIO DE RESIDENCIA. VAMOS FILTRAR PARA SALVADOR: https://cidades.ibge.gov.br/brasil/ba/salvador/panorama
# CUIDADO COM O ULTIMO DIGITO
# FILTRO:

banco_ssa_2019 <- filter(dados_sih_ba_2019, MUNIC_RES == "292740")

# MESMO COM O FILTRO, AINDA TEMOS UMA GRANDE CARGA CARGA DE DADOS, ISTO PORQUE ESTAMOS VENDO TODOS DIAGNOSTICOS POSSIVEIS. DIGAMOS
# QUE APENAS ALGUNS NOS INTERESSAM, E NESSE CASO OLHAREMOS PARA ALGUNS DAQUELES QUE SAO CONSIDERADOS IMPORTANTES COMORBIDADES PARA 
# O AGRAVAMENTO DO QUADRO DO COVID 19: DIABETES E HIPERTENSAO.

# AS DOENCAS SAO CLASSIFICADAS EM CODIGOS CHAMADOS CID (CODIGO INTERNACIONAL DE DOENCAS) E ESTES CID ESTAO REGISTRADOS EM VARIOS CAMPOS
# SEPARADOS EM NOSSO BANCO DE DADOS, TODOS ELES COMECANDO COM "DIAG_...". PARA ENTENDER A CID: http://tabnet.datasus.gov.br/cgi/sih/mxcid10lm.htm

# O MOTIVO QUE LEVOU A INTERNACAO ESTARA EM "DIAG_PRINC", E AS OUTRAS NOS OUTROS CAMPOS "DIAG". BOM LEMBRAR QUE SE OLHARMOS APENAS PARA 
# O DIAGNOSTIO PRINCIPAL, O QUAL EXPLICA O MOTIVA DESTA INTERNACAO ESPECIFICA, PODEMOS ESTAR DEIXANDO DE LADO OUTROS DIAGNOSTICOS QUE NOS
# INTERESSAM, POR ISSO VAMOS FILTRAR AGORA TANTO PELOS DIAGNOSTICO PRINCIPAL QUANTO PELO SECUNDARIO. sE VOCE QUISER IR AINDA MAIS A FUNDO, 
# PODE APLICAR FILTROS EM TODOS OS CAMPOS DE DIAGNOSTICO SEGUINDO A MESMA LOGICA. OBSERVE QUE O R ACEITA AS SINTAXES "|" E "&" PARA FILTRO
# EM CAMPOS MULTIPLOS DE UMA UNICA VEZ:


banco_ssa_comorb_2019 <- filter(banco_ssa_2019, DIAG_PRINC == "E10" | DIAG_PRINC== "E100"| DIAG_PRINC== "E101" | DIAG_PRINC == "E102"| 
                                  DIAG_PRINC == "E103"| DIAG_PRINC == "E104" | DIAG_PRINC == "E105"| DIAG_PRINC == "E106"| 
                                  DIAG_PRINC == "E107"| DIAG_PRINC == "E108"| DIAG_PRINC == "E109"| DIAG_PRINC == "E11" | 
                                  DIAG_PRINC== "E110"| DIAG_PRINC== "E111" | DIAG_PRINC == "E112"| DIAG_PRINC == "E113"| 
                                  DIAG_PRINC == "E114" | DIAG_PRINC == "E115"| DIAG_PRINC == "E116"| DIAG_PRINC == "E117"| 
                                  DIAG_PRINC == "E118"| DIAG_PRINC == "E119"|DIAG_PRINC == "E12" | DIAG_PRINC== "E120"| 
                                  DIAG_PRINC== "E121" | DIAG_PRINC == "E122"| DIAG_PRINC == "E123"| DIAG_PRINC == "E124" | 
                                  DIAG_PRINC == "E125"| DIAG_PRINC == "E126"| DIAG_PRINC == "E127"| DIAG_PRINC == "E128"| 
                                  DIAG_PRINC == "E129"|DIAG_PRINC == "E13" | DIAG_PRINC== "E130"| DIAG_PRINC== "E131" | 
                                  DIAG_PRINC == "E132"| DIAG_PRINC == "E133"| DIAG_PRINC == "E134" | DIAG_PRINC == "E135"| 
                                  DIAG_PRINC == "E136"| DIAG_PRINC == "E137"| DIAG_PRINC == "E138"| DIAG_PRINC == "E139"| 
                                  DIAG_PRINC == "E14" | DIAG_PRINC== "E140"| DIAG_PRINC== "E141" | DIAG_PRINC == "E142"| 
                                  DIAG_PRINC == "E143"| DIAG_PRINC == "E144" | DIAG_PRINC == "E145"| DIAG_PRINC == "E146"| 
                                  DIAG_PRINC == "E147"| DIAG_PRINC == "E148"| DIAG_PRINC == "E149"| DIAG_SECUN == "E10" | 
                                  DIAG_SECUN== "E100"| DIAG_SECUN== "E101" | DIAG_SECUN == "E102"| DIAG_SECUN == "E103"| 
                                  DIAG_SECUN == "E104" | DIAG_SECUN == "E105"| DIAG_SECUN == "E106"| DIAG_SECUN == "E107"| 
                                  DIAG_SECUN == "E108"| DIAG_SECUN == "E109"| DIAG_SECUN== "E11"| DIAG_SECUN== "E110" | 
                                  DIAG_SECUN == "E111"| DIAG_SECUN == "E112"| DIAG_SECUN == "E113" | DIAG_SECUN == "E114"| 
                                  DIAG_SECUN == "E115"| DIAG_SECUN == "E116"| DIAG_SECUN == "E117"| DIAG_SECUN == "E118"| 
                                  DIAG_SECUN == "E119"| DIAG_SECUN== "E12"| DIAG_SECUN== "E120" | DIAG_SECUN == "E121"| 
                                  DIAG_SECUN == "E122"| DIAG_SECUN == "E123" | DIAG_SECUN == "E124"| DIAG_SECUN == "E125"| 
                                  DIAG_SECUN == "E126"| DIAG_SECUN == "E127"| DIAG_SECUN == "E128"| DIAG_SECUN == "E129"| 
                                  DIAG_SECUN== "E13"| DIAG_SECUN== "E130" | DIAG_SECUN == "E131"| DIAG_SECUN == "E132"| 
                                  DIAG_SECUN == "E133" | DIAG_SECUN == "E134"| DIAG_SECUN == "E135"| DIAG_SECUN == "E136"| 
                                  DIAG_SECUN == "E137"| DIAG_SECUN == "E138"| DIAG_SECUN == "E139"| DIAG_SECUN== "E14"| 
                                  DIAG_SECUN== "E140" | DIAG_SECUN == "E141"| DIAG_SECUN == "E142"| DIAG_SECUN == "E143" | 
                                  DIAG_SECUN == "E144"| DIAG_SECUN == "E145"| DIAG_SECUN == "E146"| DIAG_SECUN == "E147"| 
                                  DIAG_SECUN == "E148"| DIAG_SECUN == "E149" | DIAG_PRINC== "I10"| DIAG_PRINC== "I15" | 
                                  DIAG_PRINC == "I150"| DIAG_PRINC == "I151"| DIAG_PRINC == "I152" | DIAG_PRINC == "I158"| 
                                  DIAG_PRINC == "I159"| DIAG_SECUN== "I10"| DIAG_SECUN== "I15" | DIAG_SECUN == "I150"| 
                                  DIAG_SECUN == "I151"| DIAG_SECUN == "I152" | DIAG_SECUN == "I158"| DIAG_SECUN == "I159")

# TEMOS AGORA UM BANCO COM UM NUMERO REDUZIDO DE OBSERVACOES (2980), EM UMA AREA GEOGRAFICA DEFINIDA (SALVADOR) E COM AS 
# CARACTERISTICAS QUE NOS INTERESSAM.
# PODEMOS EXPORTAR O ARQUIVO EM FORMATO AMIGAVEL, COMO CSV OU XLS, PARA USO EXTERNO (OUTROS FORMATOS SAO POSSIVEIS, CONSULTE A DOCUMENTACAO):

write.csv(banco_ssa_comorb_2019,"banco_ssa_comorb_2019.csv")

# PARA EXPORTAR COMO XLS PRECISAREMOS DE UM NOVO PACOTE:

install.packages("xlsx")

library(xlsx)

write.xlsx(banco_ssa_comorb_2019, file = "banco_ssa_comorb_2019.xlsx", sheetName = "comorbs_ssa_19", append = FALSE)

# CASO TENHA ALGUMA DIFICULDADE PARA ENTENDER AS DEFINICOES DE ARGUMENTOS EM QUALQUER FUNCAO DO R, LEMBRE-SE DO HELP:

help("xlsx-package")

# VAMOS FAZER UMA BREVE ANALISE NO BANCO RESULTANTE.
# CARREGUE O BANCO EXPORTADO PARA COMECAR:

# CASO QUEIRA USAR O XLS (OBSERVE QUE NESTE CASO ESTAMOS USANDO P COMANDO "file.choose()" QUE NOS PERMITE, AO EXECUTAR, BUSCAR O
# ARQUIVO DESEJADO EM UMA JANELA DO WINDOWS:

comorbs_xls <- read.xlsx(file.choose(), 1, encoding = "UTF8")

# CASO QUEIRA USAR O .CSV:

comorbsssa19 <- read.csv("banco_ssa_comorb_2019.csv")

# REPAREM QUE O FORMATO DO ARQUIVO INFLUENCIA BASTANTE NA PERFORMANCE, O .CSV, PELA ESTRUTURA ENXUTA, CARREGA RAPIDAMENTE.

# GERE UM HISTOGRAMA POR CEP:

contagem_cep <- table(comorbsssa19$CEP)
barplot(contagem_cep, main="Distrinuição de ocorrências por CEP",
        xlab="CEP")

# JA E POSSIVEL PERCEBER QUE EXISTEM POSSIVEIS OUTLIERS.
# PODEMOS ADICIONAR UMA LINHA DA MEDIA DE EVENTOS PRA TENTAR OBSERVAR A MAGNITUDE DA VARIANCIA ESPACIAL DO BANCO COM OS OUTILIERS
# CALCULAMOS A MEDIA DE OCORRENCIAS POR CEP:

media <- mean(contagem_cep)

# ADICIONAMOS UMA LINHA COM O VALOR MEDIO NO GRAFICO:

abline(h=media, col = "Red")

# TAMBEM PODEMOS CALCULAR A DISTRIBUICAO DOS QUANTIS PRA UMA ANALISE (https://en.wikipedia.org/wiki/Quantile):

quantis <- quantile(contagem_cep)

# E OLHARMOS O RESULTADOS:
# NO CONSOLE:

quantis

# OU COMO TABELA EM UMA ABA NESTA JANELA:

View(quantis)

# APOS OS CALCULOS PROPORCIONAIS A POPULACAO E IDADE, IMPORTANTE NA AREA DE SAUDE PUBLICA.

# VAMOS OLHAR OS DADOS POR TIPO DE DOENCA AGORA E OBSERVAR QUE EXISTEM CID'S MAIS PREVALENTES ENTRE AS DOENCAS QUE CONSIDERAMOS
# COMO COMORBIDADES NESTE EXERCICIO:

contagem_comorbs <- table(comorbsssa19$DIAG_PRINC)
barplot(contagem_comorbs, main="Doenças",
        xlab="CID")


# ESTES EXEMPLOS SAO ABORDAGENS SIMPLES E NAO ENCERRAM AS POSSIBILIDADES DE ANALISE GRAFICA OU ESTATISTICA NO R, PELO CONTRARIO, 
# APENAS PROPOE A INTRODUCAO AOS TOPICOS E A ORGANIZACAO DE DADOS PARA USO POSTERIOR. AO LONGO DO CURSO, A DEPENDER DAS DEMANDAS E 
# TAMBEM DOS INTERESSES DOS ALUNOS, PODEMOS APROFUNDAR OUTRAS FUNCIONALIDADES E ALGORITIMOS NO R.

# NO PROXIMO MODULO, ANTES DE MAPEAR OS RESULTADOS, APRENDEREMOS UM POUCO SOBRE O PROCESSO DE GEOCODIFICACAO DE ENDERECOS.


#--------------------------FIM DO MODULO 1-----------------------------------------------------------------------------------#